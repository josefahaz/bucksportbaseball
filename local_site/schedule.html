<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Bucksport Little League - Schedule</title>
  <script src="https://cdn.tailwindcss.com/3.4.1"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <style>
    body {
      background-color: #4b2d72;
      color: white;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
      line-height: 1.5;
      display: flex;
      min-height: 100vh;
    }
    .sidebar {
      width: 250px;
      background-color: #4b2d72;
      color: white;
      padding: 1.5rem 1rem;
      box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
      position: fixed;
      height: 100vh;
      overflow-y: auto;
      z-index: 1000;
    }
    .sidebar h2 {
      color: #ffc72c;
      margin-bottom: 2rem;
      padding: 0 0.5rem;
      font-size: 1.25rem;
      font-weight: 700;
    }
    .sidebar nav {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }
    .sidebar a {
      color: white;
      text-decoration: none;
      padding: 0.75rem 1rem;
      border-radius: 0.375rem;
      display: flex;
      align-items: center;
      gap: 0.75rem;
      transition: all 0.2s;
    }
    .sidebar a:hover {
      background-color: rgba(255, 255, 255, 0.1);
      color: #ffc72c;
    }
    .sidebar a.active {
      background-color: #ffc72c;
      color: #4b2d72;
      font-weight: 500;
    }
    .sidebar i {
      width: 1.5rem;
      text-align: center;
    }
    .main-content {
        margin-left: 250px; /* This is necessary because the sidebar is fixed */
        flex-grow: 1;
        padding: 2rem;
    }
    .calendar-day:hover .add-event-btn { opacity: 1; }
    .calendar-day.past-day { background-color: #f9fafb; color: #9ca3af; }
    .calendar-day.today { background-color: #e0e7ff; font-weight: bold; }
    .calendar-day.selected { background-color: #fef9c3; border-color: #facc15; box-shadow: 0 0 0 2px #facc15; }
    .event-dot { width: 6px; height: 6px; border-radius: 50%; }
    .dot-game { background-color: #3b82f6; }
    .dot-practice { background-color: #22c55e; }
    .dot-event { background-color: #f97316; }
    .accordion-content { max-height: 0; overflow: hidden; transition: max-height 0.3s ease-in-out; }
    .accordion-toggle i.rotate-180 { transform: rotate(180deg); }
      
    .sidebar-user {
      padding: 0.75rem;
      background-color: rgba(255, 199, 44, 0.1);
      border-radius: 0.5rem;
      margin-bottom: 1rem;
      border: 1px solid rgba(255, 199, 44, 0.2);
    }
    
    .sidebar-user-name {
      color: #ffc72c;
      font-size: 0.875rem;
      font-weight: 600;
      margin-bottom: 0.5rem;
    }
    
    .sidebar-logout-btn {
      background-color: rgba(255, 255, 255, 0.1);
      color: white;
      border: 1px solid rgba(255, 255, 255, 0.2);
      padding: 0.5rem 0.75rem;
      border-radius: 0.375rem;
      font-size: 0.875rem;
      cursor: pointer;
      width: 100%;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
    }
    
    .sidebar-logout-btn:hover {
      background-color: rgba(255, 255, 255, 0.2);
      border-color: rgba(255, 255, 255, 0.3);
    }
  </style>
</head>
<body>

  <div class="sidebar">
    <div class="sidebar-header">
      <h2>Bucksport LL</h2>
    </div>
    <!-- User Welcome Section -->
    <div class="sidebar-user" id="sidebarUserSection" style="display: none;">
      <div class="sidebar-user-name" id="sidebarUserName">Welcome, User</div>
      <button class="sidebar-logout-btn" id="sidebarLogoutBtn">
        <i class="fas fa-sign-out-alt"></i> Logout
      </button>
    </div>
    <nav class="sidebar-nav">
      <a href="index.html"><i class="fas fa-home"></i> Home</a>
      <a href="teams.html"><i class="fas fa-users"></i> Teams</a>
      <a href="coach-dashboard.html"><i class="fas fa-tachometer-alt"></i> Coach Dashboard</a>
      <a href="inventory.html"><i class="fas fa-tshirt"></i> Equipment Inventory</a>
      <a href="schedule.html" class="active"><i class="fas fa-calendar-alt"></i> Schedule</a>
      <a href="concessions.html"><i class="fas fa-hamburger"></i> Concessions</a>
      <a href="event_concessions.html"><i class="fas fa-clipboard-list"></i> Event Concessions</a>
      <a href="fundraising.html"><i class="fas fa-hand-holding-usd"></i> Fundraising & Donations</a>
</nav>
  </div>

  <div class="main-content">
    <div class="container mx-auto text-gray-800">
        
        <header class="text-center mb-8 relative">
            <img src="images/logo.png" alt="Bucksport Little League Logo" class="mx-auto h-24 mb-4">
            <h1 class="text-3xl font-extrabold" style="color: #ffc72c; text-shadow: 0 2px 4px rgba(0,0,0,0.2);">League Schedule</h1>
            <p class="text-gray-300 mt-2">Use the filters to view specific schedules and click on a day to see details.</p>
            <!-- Activity Log Button -->
            <button id="viewActivityLog" class="absolute top-8 right-4 bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-md text-sm font-semibold transition-colors">
              <i class="fas fa-history"></i> Activity Log
            </button>
        </header>

        <!-- Filters and Color Guide -->
        <div class="bg-white rounded-lg shadow-lg p-4 mb-6 text-gray-800">
            <div class="flex flex-wrap items-center justify-between gap-4">
                <!-- Filters -->
                <div class="flex items-center gap-4 flex-wrap">
                    <div class="flex items-center gap-2">
                        <label for="locationFilter" class="font-semibold text-sm">Location:</label>
                        <select id="locationFilter" class="bg-white border-gray-300 rounded-md shadow-sm text-sm p-2">
                            <option value="all">All Locations</option>
                            <!-- Options will be populated by JS -->
                        </select>
                    </div>
                    <div class="flex items-center gap-2">
                        <label for="teamFilter" class="font-semibold text-sm">Team:</label>
                        <select id="teamFilter" class="bg-white border-gray-300 rounded-md shadow-sm text-sm p-2">
                            <option value="all">All Teams</option>
                            <!-- Options will be populated by JS -->
                        </select>
                    </div>
                    <div class="flex items-center gap-2">
                        <label for="coachFilter" class="font-semibold text-sm">Coach:</label>
                        <select id="coachFilter" class="bg-white border-gray-300 rounded-md shadow-sm text-sm p-2">
                            <option value="all">All Coaches</option>
                            <!-- Options will be populated by JS -->
                        </select>
                    </div>
                    <button id="resetFilters" class="bg-gray-200 hover:bg-gray-300 text-gray-700 font-semibold py-2 px-4 rounded-md text-sm">
                        Reset
                    </button>
                </div>
                <!-- Color Guide -->
                <div class="flex items-center gap-4 text-sm">
                    <span class="font-semibold">Legend:</span>
                    <div class="flex items-center gap-1">
                        <span class="w-4 h-4 rounded-full bg-blue-500"></span>
                        <span>Game</span>
                    </div>
                    <div class="flex items-center gap-1">
                        <span class="w-4 h-4 rounded-full bg-green-500"></span>
                        <span>Practice</span>
                    </div>
                    <div class="flex items-center gap-1">
                        <span class="w-4 h-4 rounded-full bg-orange-500"></span>
                        <span>Event</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Schedule Area -->
        <div class="flex flex-col lg:flex-row gap-8">

            <!-- Left Column: Upcoming Events -->
            <div class="lg:w-4/12">
                <div id="upcomingEvents" class="bg-white rounded-lg shadow-lg p-6">
                    <h3 class="text-xl font-bold text-purple-900 mb-4">Upcoming Events</h3>
                    <div id="upcomingEventsAccordion">
                        <!-- Loading skeleton -->
                        <div class="animate-pulse space-y-3">
                            <div class="h-10 bg-gray-200 rounded"></div>
                            <div class="h-10 bg-gray-200 rounded"></div>
                            <div class="h-10 bg-gray-200 rounded"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Center Column: Calendar -->
            <div class="lg:w-5/12 flex-grow">
                <div class="bg-white rounded-lg shadow-lg p-6">
                    <div class="flex justify-between items-center mb-4">
                    <button id="prevMonth" class="p-2 rounded-full hover:bg-gray-200 transition-colors">
                        <i class="fas fa-chevron-left"></i>
                    </button>
                    <h2 id="currentMonthYear" class="text-2xl font-bold text-purple-900"></h2>
                    <button id="nextMonth" class="p-2 rounded-full hover:bg-gray-200 transition-colors">
                        <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
                <div class="grid grid-cols-7 gap-2 text-center font-semibold text-gray-600 mb-2">
                    <div>Sun</div><div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div>
                </div>
                <div id="calendarDays" class="grid grid-cols-7 gap-2">
                    <!-- Loading skeleton for calendar -->
                    <div class="animate-pulse col-span-7 grid grid-cols-7 gap-2">
                        <div class="h-24 bg-gray-200 rounded"></div>
                        <div class="h-24 bg-gray-200 rounded"></div>
                        <div class="h-24 bg-gray-200 rounded"></div>
                        <div class="h-24 bg-gray-200 rounded"></div>
                        <div class="h-24 bg-gray-200 rounded"></div>
                        <div class="h-24 bg-gray-200 rounded"></div>
                        <div class="h-24 bg-gray-200 rounded"></div>
                    </div>
                </div>
            </div>
            </div>

            <!-- Right Column: Daily Schedule -->
            <div class="lg:w-3/12">
                <div id="dailyScheduleContainer" class="bg-white rounded-lg shadow-lg p-6">
                    <h3 id="dailyScheduleHeader" class="text-xl font-bold text-purple-900 mb-4">Schedule for Selected Day</h3>
                    <div id="dailySchedule" class="space-y-4">
                        <!-- Daily schedule cards will be populated by JS -->
                    </div>
                </div>
            </div>

        </div>
    </div>
  </div>

    <div id="eventRequestModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-lg p-6 mx-4">
            <div class="flex justify-between items-center border-b pb-3 mb-4">
                <h3 class="text-xl font-bold text-purple-900">Request a New Event</h3>
                <button id="closeEventModal" class="text-gray-500 hover:text-gray-800 text-2xl font-bold">&times;</button>
            </div>
            <form id="eventRequestForm">
                <input type="hidden" id="eventRequestDate" name="date">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label for="eventTitle" class="block text-sm font-medium text-gray-700 mb-1">Event Title</label>
                        <input type="text" id="eventTitle" name="title" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm bg-white text-gray-900 focus:ring-2 focus:ring-purple-500 focus:border-purple-500" required>
                    </div>
                    <div>
                        <label for="eventTime" class="block text-sm font-medium text-gray-700 mb-1">Time</label>
                        <input type="time" id="eventTime" name="time" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm bg-white text-gray-900 focus:ring-2 focus:ring-purple-500 focus:border-purple-500" required>
                    </div>
                    <div>
                        <label for="eventType" class="block text-sm font-medium text-gray-700 mb-1">Event Type</label>
                        <select id="eventType" name="type" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm bg-white text-gray-900 focus:ring-2 focus:ring-purple-500 focus:border-purple-500">
                            <option value="game">Game</option>
                            <option value="practice">Practice</option>
                            <option value="event">General Event</option>
                        </select>
                    </div>
                    <div>
                        <label for="eventRequestTeam" class="block text-sm font-medium text-gray-700 mb-1">Team <span class="text-gray-400 font-normal">(optional)</span></label>
                        <select id="eventRequestTeam" name="team_id" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm bg-white text-gray-900 focus:ring-2 focus:ring-purple-500 focus:border-purple-500">
                            <option value="">No team</option>
                        </select>
                    </div>
                     <div>
                        <label for="eventRequestCoach" class="block text-sm font-medium text-gray-700 mb-1">Coach <span class="text-gray-400 font-normal">(optional)</span></label>
                        <select id="eventRequestCoach" name="coach_id" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm bg-white text-gray-900 focus:ring-2 focus:ring-purple-500 focus:border-purple-500">
                            <option value="">No coach</option>
                        </select>
                    </div>
                </div>
                <div class="mb-4">
                    <label for="eventLocation" class="block text-sm font-medium text-gray-700 mb-1">Location</label>
                    <input type="text" id="eventLocation" name="location" list="locations" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm bg-white text-gray-900 focus:ring-2 focus:ring-purple-500 focus:border-purple-500" required>
                    <datalist id="locations"></datalist>
                </div>
                <div class="mb-4">
                    <label for="eventNotes" class="block text-sm font-medium text-gray-700 mb-1">Notes</label>
                    <textarea id="eventNotes" name="notes" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm bg-white text-gray-900 focus:ring-2 focus:ring-purple-500 focus:border-purple-500"></textarea>
                </div>
                <div class="mb-4 flex items-center gap-2">
                    <input type="checkbox" id="syncGoogleCalendar" name="sync_google" class="w-4 h-4 text-purple-600 border-gray-300 rounded focus:ring-purple-500">
                    <label for="syncGoogleCalendar" class="text-sm text-gray-700">
                        <i class="fab fa-google text-red-500 mr-1"></i>Add to Google Calendar
                    </label>
                </div>
                <div class="flex justify-end gap-4">
                    <button type="button" id="cancelEventRequest" class="px-4 py-2 bg-gray-200 rounded-md hover:bg-gray-300">Cancel</button>
                    <button type="submit" class="px-4 py-2 text-white rounded-md bg-purple-800 hover:bg-purple-900">Submit Request</button>
                </div>
            </form>
        </div>
    </div>

<script src="js/auth.js"></script>
<script src="js/api.js"></script>
<script src="js/activity-log.js"></script>
<script>
    // Pre-warm the API server immediately (don't wait for DOM)
    // This helps reduce cold start delays on Render free tier
    fetch('https://bucksport-api.onrender.com/api/health').catch(() => {});
    
    // Initialize Activity Logger (with fallback if script didn't load)
    let activityLogger = null;
    try {
        if (typeof ActivityLogger !== 'undefined') {
            activityLogger = new ActivityLogger('schedule');
        }
    } catch (e) {
        console.warn('ActivityLogger not available:', e);
    }
    
    document.addEventListener('DOMContentLoaded', () => {
      // Only initialize activity log if available
      if (activityLogger && typeof createActivityLogModal === 'function') {
          createActivityLogModal();
          activityLogger.initializeModal();
          activityLogger.logActivity('Page View', 'Schedule page loaded');
      }
        // --- State ---
        let currentDate = new Date();
        let selectedDate = null;
        let allScheduleData = [];
        let allLocations = [];
        let allTeams = [];
        let allCoaches = [];
        let currentFilters = { location: 'all', team: 'all', coach: 'all' };

        // --- DOM Elements ---
        const locationFilter = document.getElementById('locationFilter');
        const teamFilter = document.getElementById('teamFilter');
        const coachFilter = document.getElementById('coachFilter');
        const resetFiltersBtn = document.getElementById('resetFilters');
        const calendarDaysEl = document.getElementById('calendarDays');
        const currentMonthYearEl = document.getElementById('currentMonthYear');
        const upcomingEventsAccordionEl = document.getElementById('upcomingEventsAccordion');
        const dailyScheduleEl = document.getElementById('dailySchedule');
        const dailyScheduleHeaderEl = document.getElementById('dailyScheduleHeader');
        const modal = document.getElementById('eventRequestModal');
        const closeModalBtn = document.getElementById('closeEventModal');
        const cancelModalBtn = document.getElementById('cancelEventRequest');
        const eventForm = document.getElementById('eventRequestForm');
        const eventDateInput = document.getElementById('eventRequestDate');

        // --- Initialization ---
        async function initializeSchedulePage() {
            // Show loading message
            const loadingMsg = document.createElement('div');
            loadingMsg.id = 'loadingOverlay';
            loadingMsg.className = 'fixed top-4 left-1/2 transform -translate-x-1/2 bg-purple-800 text-white px-6 py-3 rounded-lg shadow-lg z-50 flex items-center gap-3';
            loadingMsg.innerHTML = `
                <svg class="animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <span>Loading schedule data...</span>
            `;
            document.body.appendChild(loadingMsg);
            
            const startTime = Date.now();
            
            try {
                [allScheduleData, allLocations, allTeams, allCoaches] = await Promise.all([
                    fetchSchedule(),
                    fetchLocations(),
                    fetchTeams(),
                    fetchCoaches()
                ]);
                populateFilters();
                renderAllComponents();
                
                // Log load time for debugging
                const loadTime = ((Date.now() - startTime) / 1000).toFixed(1);
                console.log(`Schedule page loaded in ${loadTime}s`);
            } catch (error) {
                console.error("Failed to initialize schedule page:", error);
                calendarDaysEl.innerHTML = `<p class="text-red-500 text-center col-span-7">Failed to load schedule data. Please try refreshing the page.</p>`;
                upcomingEventsAccordionEl.innerHTML = `<p class="text-red-500">Failed to load events.</p>`;
            } finally {
                // Remove loading overlay
                document.getElementById('loadingOverlay')?.remove();
            }
        }

        // --- Data & Filtering ---
        const formatDate = (date) => {
            const d = new Date(date);
            d.setMinutes(d.getMinutes() + d.getTimezoneOffset()); // Adjust for timezone
            return d.toISOString().split('T')[0];
        };

        const getFilteredSchedule = () => {
            return allScheduleData.filter(event => {
                const locationMatch = currentFilters.location === 'all' || event.location === currentFilters.location;
                const teamMatch = currentFilters.team === 'all' || event.team_id == currentFilters.team;
                const coachMatch = currentFilters.coach === 'all' || event.coach_id == currentFilters.coach;
                return locationMatch && teamMatch && coachMatch;
            });
        };

        const getEventsForDate = (dateStr) => getFilteredSchedule().filter(event => event.date === dateStr);

        // --- Rendering ---
        function renderAllComponents() {
            generateCalendar(currentDate.getFullYear(), currentDate.getMonth());
            renderUpcomingEvents();
            const todayStr = formatDate(new Date());
            if (!selectedDate && getEventsForDate(todayStr).length > 0) {
                selectedDate = todayStr;
            }
            renderDailySchedule(selectedDate);
        }

        function populateFilters() {
            const populate = (selectEl, data, valueField = 'id', nameField = 'name') => {
                const currentValue = selectEl.value;
                selectEl.innerHTML = `<option value="all">All ${selectEl.id.replace('Filter', 's')}</option>`;
                data.sort((a, b) => a[nameField].localeCompare(b[nameField])).forEach(item => {
                    const option = document.createElement('option');
                    option.value = item[valueField];
                    option.textContent = item[nameField];
                    selectEl.appendChild(option);
                });
                selectEl.value = currentValue;
            };
            populate(locationFilter, allLocations.map(l => ({id: l, name: l})), 'name', 'name'); // Use name for both value and text
            populate(teamFilter, allTeams);
            populate(coachFilter, allCoaches);
        }

        function generateCalendar(year, month) {
            calendarDaysEl.innerHTML = '';
            currentMonthYearEl.textContent = new Date(year, month).toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const daysInMonth = lastDay.getDate();
            const startDayOfWeek = firstDay.getDay();

            for (let i = 0; i < startDayOfWeek; i++) {
                calendarDaysEl.insertAdjacentHTML('beforeend', `<div class="p-2 h-24 border rounded-md text-center text-gray-400 bg-gray-50"></div>`);
            }

            for (let day = 1; day <= daysInMonth; day++) {
                const fullDate = new Date(year, month, day);
                const dateStr = formatDate(fullDate);
                const events = getEventsForDate(dateStr);
                const today = new Date(); today.setHours(0, 0, 0, 0);
                
                let dayClasses = 'calendar-day relative p-2 h-24 border rounded-md text-center cursor-pointer transition-colors duration-200';
                if (fullDate < today) dayClasses += ' past-day';
                if (fullDate.getTime() === today.getTime()) dayClasses += ' today';
                if (selectedDate && dateStr === selectedDate) dayClasses += ' selected';

                const dayCell = document.createElement('div');
                dayCell.className = dayClasses;
                dayCell.innerHTML = `
                    <span class="font-medium">${day}</span>
                    <button class="add-event-btn absolute top-1 right-1 text-purple-500 hover:text-purple-800 opacity-0 transition-opacity text-xs" title="Add event"><i class="fas fa-plus-circle"></i></button>
                    <div class="event-dots absolute bottom-2 left-1/2 -translate-x-1/2 flex space-x-1"></div>
                `;
                
                if (events.length > 0) {
                    const eventTypes = [...new Set(events.map(e => e.type))];
                    const dotsContainer = dayCell.querySelector('.event-dots');
                    eventTypes.slice(0, 3).forEach(type => {
                        dotsContainer.innerHTML += `<span class="event-dot dot-${type}"></span>`;
                    });
                }

                dayCell.addEventListener('click', () => {
                    selectedDate = dateStr;
                    renderAllComponents();
                });
                dayCell.querySelector('.add-event-btn').addEventListener('click', (e) => { e.stopPropagation(); openModal(fullDate); });
                calendarDaysEl.appendChild(dayCell);
            }
        }
        
        // Helper to escape HTML to prevent XSS and display issues
        const escapeHtml = (text) => {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        };
        
        // Helper to truncate long text
        const truncate = (text, maxLength = 100) => {
            if (!text || text.length <= maxLength) return text;
            return text.substring(0, maxLength) + '...';
        };

        function renderDailySchedule(dateStr) {
            dailyScheduleEl.innerHTML = '';
            if (!dateStr) {
                dailyScheduleHeaderEl.textContent = 'Select a day';
                dailyScheduleEl.innerHTML = '<p class="text-gray-500">Click on a day in the calendar to see its schedule.</p>';
                return;
            }
            const events = getEventsForDate(dateStr);
            dailyScheduleHeaderEl.textContent = `Schedule for ${new Date(dateStr.replace(/-/g, '/')).toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' })}`;
            if (events.length === 0) {
                dailyScheduleEl.innerHTML = '<p class="text-gray-500">No events scheduled for this day.</p>';
                return;
            }
            events.forEach(event => {
                const eventTypeClass = `bg-${event.type === 'game' ? 'blue' : event.type === 'practice' ? 'green' : 'orange'}-500`;
                const coachName = allCoaches.find(c => c.id == event.coach_id)?.name || 'N/A';
                const teamName = allTeams.find(t => t.id == event.team_id)?.name || 'N/A';
                const safeLocation = escapeHtml(truncate(event.location, 50));
                const safeNotes = escapeHtml(truncate(event.notes, 150));

                dailyScheduleEl.innerHTML += `
                    <div class="bg-gray-50 p-3 rounded-lg border-l-4 border-${event.type === 'game' ? 'blue' : event.type === 'practice' ? 'green' : 'orange'}-500">
                        <p class="font-bold text-purple-800">${escapeHtml(event.title)}</p>
                        <p class="text-sm text-gray-600"><i class="far fa-clock mr-2"></i>${escapeHtml(event.time)}</p>
                        <p class="text-sm text-gray-600"><i class="fas fa-map-marker-alt mr-2"></i>${safeLocation}</p>
                        <p class="text-sm text-gray-600"><i class="fas fa-users mr-2"></i>${escapeHtml(teamName)}</p>
                        <p class="text-sm text-gray-600"><i class="fas fa-user mr-2"></i>${escapeHtml(coachName)}</p>
                        ${safeNotes ? `<p class="text-xs text-gray-500 mt-2"><em>${safeNotes}</em></p>` : ''}
                    </div>
                `;
            });
        }

        function renderUpcomingEvents() {
            upcomingEventsAccordionEl.innerHTML = '';
            const today = new Date();
            today.setHours(0,0,0,0);
            const upcoming = getFilteredSchedule().filter(e => new Date(e.date.replace(/-/g, '/')) >= today).sort((a,b) => new Date(a.date) - new Date(b.date)).slice(0, 5);
            if(upcoming.length === 0) {
                upcomingEventsAccordionEl.innerHTML = '<p class="text-gray-500">No upcoming events found.</p>';
                return;
            }
            upcoming.forEach(event => {
                 upcomingEventsAccordionEl.innerHTML += `
                    <div class="mb-2">
                        <button class="accordion-toggle w-full text-left p-3 bg-gray-100 hover:bg-gray-200 rounded-md flex justify-between items-center">
                            <span class="font-semibold text-gray-800">${escapeHtml(event.title)}</span>
                            <i class="fas fa-chevron-down transition-transform duration-200"></i>
                        </button>
                        <div class="accordion-content overflow-hidden max-h-0 transition-all duration-200">
                            <div class="p-3 bg-white border border-t-0 border-gray-200 rounded-b-md">
                                <p class="text-sm text-gray-700"><strong>Date:</strong> ${new Date(event.date.replace(/-/g, '/')).toLocaleDateString()}</p>
                                <p class="text-sm text-gray-700"><strong>Time:</strong> ${escapeHtml(event.time)}</p>
                                <p class="text-sm text-gray-700"><strong>Location:</strong> ${escapeHtml(truncate(event.location, 40))}</p>
                            </div>
                        </div>
                    </div>
                `;
            });
        }

        // --- Event Handlers ---
        document.getElementById('prevMonth').addEventListener('click', () => { currentDate.setMonth(currentDate.getMonth() - 1); renderAllComponents(); });
        document.getElementById('nextMonth').addEventListener('click', () => { currentDate.setMonth(currentDate.getMonth() + 1); renderAllComponents(); });
        [locationFilter, teamFilter, coachFilter].forEach(el => {
            el.addEventListener('change', (e) => {
                const key = el.id.replace('Filter', '');
                currentFilters[key] = e.target.value;
                renderAllComponents();
            });
        });
        resetFiltersBtn.addEventListener('click', () => {
            currentFilters = { location: 'all', team: 'all', coach: 'all' };
            ['locationFilter', 'teamFilter', 'coachFilter'].forEach(id => document.getElementById(id).value = 'all');
            renderAllComponents();
        });
        upcomingEventsAccordionEl.addEventListener('click', (e) => {
            const toggle = e.target.closest('.accordion-toggle');
            if (toggle) {
                const content = toggle.nextElementSibling;
                toggle.querySelector('i').classList.toggle('rotate-180');
                content.style.maxHeight = content.style.maxHeight ? null : content.scrollHeight + 'px';
            }
        });

        // --- Modal Logic ---
        const openModal = (date) => {
            eventForm.reset();
            eventDateInput.value = formatDate(date);
            // Populate modal dropdowns
            const teamSelect = document.getElementById('eventRequestTeam');
            const coachSelect = document.getElementById('eventRequestCoach');
            const locationDatalist = document.getElementById('locations');
            
            teamSelect.innerHTML = '<option value="">No team</option>';
            allTeams.forEach(t => teamSelect.innerHTML += `<option value="${t.id}">${t.name}</option>`);

            coachSelect.innerHTML = '<option value="">No coach</option>';
            allCoaches.forEach(c => coachSelect.innerHTML += `<option value="${c.id}">${c.name}</option>`);
            
            locationDatalist.innerHTML = '';
            allLocations.forEach(l => locationDatalist.innerHTML += `<option value="${l}">`);

            modal.classList.remove('hidden');
        };
        const closeModal = () => modal.classList.add('hidden');
        closeModalBtn.addEventListener('click', closeModal);
        cancelModalBtn.addEventListener('click', closeModal);
        
        // Function to create Google Calendar URL
        const createGoogleCalendarUrl = (eventData) => {
            const title = encodeURIComponent(eventData.title);
            const location = encodeURIComponent(eventData.location || '');
            const notes = encodeURIComponent(eventData.notes || '');
            
            // Parse date and time
            const dateStr = eventData.date; // YYYY-MM-DD
            const timeStr = eventData.time; // HH:MM (24hr)
            
            // Create start datetime
            const startDate = new Date(`${dateStr}T${timeStr}`);
            // Assume 1 hour duration for events, 2 hours for games
            const durationHours = eventData.type === 'game' ? 2 : 1;
            const endDate = new Date(startDate.getTime() + durationHours * 60 * 60 * 1000);
            
            // Format for Google Calendar (YYYYMMDDTHHmmss)
            const formatGoogleDate = (d) => {
                return d.toISOString().replace(/[-:]/g, '').replace(/\.\d{3}/, '');
            };
            
            const dates = `${formatGoogleDate(startDate)}/${formatGoogleDate(endDate)}`;
            
            return `https://calendar.google.com/calendar/render?action=TEMPLATE&text=${title}&dates=${dates}&location=${location}&details=${notes}`;
        };
        
        eventForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(eventForm);
            const eventData = Object.fromEntries(formData.entries());
            const syncGoogle = document.getElementById('syncGoogleCalendar').checked;
            
            try {
                const response = await requestNewEvent(eventData);
                
                // Open Google Calendar if checkbox is checked
                if (syncGoogle) {
                    const googleUrl = createGoogleCalendarUrl(eventData);
                    window.open(googleUrl, '_blank');
                }
                
                alert('Event request submitted successfully!');
                closeModal();
                await initializeSchedulePage(); // Refresh data
            } catch (error) {
                console.error('Failed to submit request:', error);
                alert('Failed to submit request. Please try again.');
            }
        });

        // --- Initial Load ---
        initializeSchedulePage();
    });
</script>

</body>
</html>
